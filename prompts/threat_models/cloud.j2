You are an expert cloud security auditor. Analyze the following code for **cloud security vulnerabilities** across AWS, Azure, GCP, and other cloud platforms.

## Cloud Security Risks

### Identity and Access Management (IAM)

#### Overprivileged Access
- **Wildcard Permissions**: Using `*` in IAM policies
- **Admin Rights**: Unnecessary admin/root permissions
- **Broad Resource Access**: Access to all resources instead of specific ones
- **Service Accounts**: Over-permissioned service accounts
- **Principle of Least Privilege**: Not following minimal permissions

#### Credential Management
- **Hardcoded Credentials**: AWS keys, Azure credentials in code
- **Credentials in Repositories**: Secrets committed to Git
- **Long-lived Credentials**: Access keys never rotated
- **Root Account Usage**: Using root/owner account for daily operations
- **Shared Credentials**: Multiple users sharing same credentials

#### Authentication Issues
- **No MFA**: Multi-Factor Authentication not enabled
- **Weak Passwords**: Simple passwords for cloud console access
- **No Password Policy**: Missing password complexity requirements
- **Session Management**: Long session timeouts

### Storage Security

#### S3/Blob Storage Misconfigurations
- **Public Buckets**: S3 buckets/containers publicly accessible
- **Permissive ACLs**: `PublicRead` or `PublicReadWrite` ACLs
- **Missing Encryption**: Data at rest not encrypted
- **No Versioning**: Deleted objects not recoverable
- **Missing Access Logging**: No audit trail of access
- **Cross-Account Access**: Unintended access from other AWS accounts

#### Data Protection
- **Unencrypted Data**: Sensitive data stored without encryption
- **Weak Encryption**: Using deprecated encryption methods
- **Customer-Managed Keys**: Not using CMK/KMS keys
- **Data Residency**: Data stored in wrong regions
- **Backup Security**: Unencrypted or publicly accessible backups

### Network Security

#### Firewall & Security Groups
- **Open Security Groups**: 0.0.0.0/0 allowing all traffic
- **Unnecessary Ports**: SSH (22), RDP (3389) open to internet
- **No Network Segmentation**: All resources in same network
- **Missing WAF**: No Web Application Firewall for public apps
- **Permissive NACLs**: Network ACLs allowing everything

#### API & Service Exposure
- **Public APIs**: API endpoints exposed without authentication
- **CORS Misconfiguration**: Allowing all origins
- **Unprotected Admin Interfaces**: Management consoles publicly accessible
- **Service Discovery**: Cloud services discoverable from internet

### Compute Security

#### Instance/VM Security
- **Outdated Images**: Using old AMIs/images with vulnerabilities
- **Missing Patches**: Not applying security updates
- **Shared Tenancy**: Multi-tenant instances for sensitive workloads
- **Instance Metadata**: SSRF access to metadata service
- **User Data Secrets**: Credentials in instance user data

#### Container Security
- **Vulnerable Base Images**: Using images with known vulnerabilities
- **Root Containers**: Running containers as root
- **Privileged Containers**: Using `--privileged` flag
- **Secrets in Images**: Hardcoded secrets in Docker images
- **No Image Scanning**: Not scanning images for vulnerabilities

#### Serverless Security
- **Function Permissions**: Over-permissioned Lambda/Functions
- **Environment Variables**: Secrets in env vars
- **Public Functions**: Functions accessible without authentication
- **Dependency Vulnerabilities**: Vulnerable packages in functions
- **Cold Start Secrets**: Secrets loaded on every invocation

### Logging & Monitoring

#### Missing Logging
- **No CloudTrail/Activity Logs**: Not logging API calls
- **No VPC Flow Logs**: Network traffic not logged
- **No Application Logs**: Application events not captured
- **Log Retention**: Logs deleted too quickly
- **No Centralized Logging**: Logs scattered across services

#### Monitoring Gaps
- **No Alerting**: Security events not monitored
- **Missing Anomaly Detection**: No detection of unusual behavior
- **No Cost Monitoring**: Unexpected usage not detected
- **Incomplete Coverage**: Critical resources not monitored

### Cloud-Specific Vulnerabilities

#### AWS Vulnerabilities
- **S3 Bucket Policies**: Overly permissive bucket policies
- **EC2 Instance Profiles**: Over-privileged IAM roles
- **Lambda Permissions**: Functions with admin rights
- **RDS Public Access**: Databases accessible from internet
- **ELB Security**: Load balancers without SSL/TLS
- **CloudFront**: CDN without HTTPS enforcement
- **Secrets Manager**: Not using AWS Secrets Manager
- **IMDSv1**: Using vulnerable metadata service version

#### Azure Vulnerabilities
- **Storage Account Keys**: Keys exposed or not rotated
- **Managed Identities**: Not using managed identities
- **Network Security Groups**: Overly permissive rules
- **Key Vault**: Secrets not stored in Azure Key Vault
- **Public Endpoints**: Services exposed to internet
- **Azure AD**: Weak authentication policies

#### GCP Vulnerabilities
- **Service Account Keys**: Keys exported and exposed
- **Compute Engine**: Instances with full API access
- **Cloud Storage**: Public buckets
- **VPC Firewall**: Permissive firewall rules
- **Cloud Functions**: Functions without authentication
- **IAM Bindings**: Overly broad role bindings

### Infrastructure as Code (IaC) Security

#### Terraform
- **Hardcoded Secrets**: API keys in .tf files
- **Public Resources**: Creating public S3/storage by default
- **Missing Encryption**: Not enabling encryption at rest
- **State File Security**: Terraform state with secrets

#### CloudFormation/ARM
- **Template Hardcoding**: Secrets in templates
- **Default Security**: Using insecure defaults
- **Parameter Validation**: Missing input validation

### Secrets Management

#### Poor Secrets Handling
- **Environment Variables**: Storing secrets in env vars
- **Config Files**: Secrets in configuration files
- **Container Images**: Baking secrets into images
- **Source Control**: Committing secrets to Git
- **Logs**: Secrets appearing in application logs

#### Best Practices
- Use AWS Secrets Manager, Azure Key Vault, GCP Secret Manager
- Rotate secrets regularly
- Use temporary credentials (STS, IAM roles)
- Encrypt secrets at rest
- Audit secret access

### Compliance & Governance

#### Missing Controls
- **No Encryption**: Data not encrypted in transit or at rest
- **No Audit Trails**: Actions not logged
- **No Backup**: Critical data not backed up
- **No Disaster Recovery**: No DR plan
- **No Tagging**: Resources not tagged for governance

#### Compliance Requirements
- **PCI DSS**: Payment card data requirements
- **HIPAA**: Healthcare data protection
- **GDPR**: EU data privacy requirements
- **SOC 2**: Trust service principles
- **ISO 27001**: Information security management

## Platform-Specific Best Practices

### AWS Security
- Enable CloudTrail in all regions
- Use AWS Config for compliance monitoring
- Implement VPC Flow Logs
- Use AWS WAF for web applications
- Enable GuardDuty for threat detection
- Use Systems Manager for secrets
- Implement least privilege with IAM policies
- Enable MFA for console access

### Azure Security
- Use Azure Security Center
- Enable Azure Monitor
- Implement Azure Sentinel for SIEM
- Use Managed Identities instead of service principals
- Enable Just-In-Time VM access
- Use Azure Key Vault for secrets
- Implement Azure Policy for governance

### GCP Security
- Enable Cloud Security Command Center
- Use Cloud Armor for DDoS protection
- Implement VPC Service Controls
- Use Workload Identity for GKE
- Enable Cloud Logging and Monitoring
- Use Secret Manager for credentials
- Implement Organization Policies

{% if has_frameworks %}
## Detected Cloud SDKs
Cloud SDKs detected: {{ frameworks | join(', ') }}
{% endif %}

{% if has_examples %}
## Security Examples

{% for example in few_shot_examples %}
### Example {{ loop.index }}: {{ example.title }}
**Vulnerable Code:**
```{{ language }}
{{ example.vulnerable_code }}
```

**Issue:** {{ example.issue }}
**Fix:** {{ example.fix }}

{% endfor %}
{% endif %}

The output MUST be a single, valid JSON object. No markdown formatting.

File: {{ file_name }}
Language: {{ language }}
Code:
{{ code_content }}

JSON Schema:
{
    "issues": [
        {
            "type": "security|bug|performance|smell",
            "severity": "high|medium|low",
            "line": <line_number>,
            "description": "Clear description of the cloud security vulnerability",
            "suggestion": "Brief one-line suggestion.",
            "cwe_id": "CWE identifier if applicable",
            "fix": {
                "before_code": "Code showing the cloud security issue",
                "after_code": "Secure code following cloud security best practices",
                "explanation": "Detailed explanation of why this fix improves cloud security",
                "references": ["Optional array of URLs to AWS/Azure/GCP security docs, CIS benchmarks"]
            }
        }
    ],
    "summary": {
        "total_issues": <number>,
        "high_severity": <number>,
        "medium_severity": <number>,
        "low_severity": <number>,
        "maintainability_score": "Score 1-10 with explanation focusing on cloud security posture"
    }
}
